"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var _npm_1 = require("./@npm");
var task_utils_1 = require("../task.utils");
var debug = require("debug")("cb:@bg");
var merge = require("../../lodash.custom").merge;
function default_1(task, trigger) {
    // todo teardown multiple background emitters on ExitSignal
    //
    var emitter;
    trigger.config.signalObserver.subscribe(function (signal) {
        if (emitter) {
            _npm_1.teardown(emitter, task);
        }
    });
    return function (opts, ctx, done) {
        var args = _npm_1.getArgs(task.command);
        var npmEnv = _npm_1.getEnv(process, trigger.config);
        var cbEnv = task_utils_1.getCBEnv(trigger);
        var ctxEnv = task_utils_1.getContextEnv(trigger, ctx);
        var env = merge({}, process.env, npmEnv, cbEnv, task.env, trigger.config.env, ctxEnv);
        var stdio = _npm_1.getStdio(trigger);
        debug("running %s", args.cmd);
        emitter = _npm_1.runCommand(args.cmd, {
            cwd: trigger.config.cwd,
            env: env,
            stdio: stdio
        });
        emitter.on("close", function (code) {
            _npm_1.teardown(emitter, task);
        }).on("error", function (err) {
            done(err);
        });
        done(null, function tearDownBgAdaptor() {
            _npm_1.teardown(emitter, task);
        });
    };
}
exports.default = default_1;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQGJnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2FkYXB0b3JzL0BiZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLCtCQUF1RTtBQUV2RSw0Q0FBc0Q7QUFDdEQsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3pDLElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUVuRCxtQkFBeUIsSUFBVSxFQUFFLE9BQXVCO0lBRXhELDJEQUEyRDtJQUMzRCxFQUFFO0lBQ0YsSUFBSSxPQUFPLENBQUM7SUFFWixPQUFPLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsVUFBVSxNQUFNO1FBQ3BELElBQUksT0FBTyxFQUFFO1lBQ1QsZUFBUSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztTQUMzQjtJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTyxVQUFVLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSTtRQUU1QixJQUFNLElBQUksR0FBSyxjQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3JDLElBQU0sTUFBTSxHQUFHLGFBQU0sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQy9DLElBQU0sS0FBSyxHQUFJLHFCQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDakMsSUFBTSxNQUFNLEdBQUcsMEJBQWEsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDM0MsSUFBTSxHQUFHLEdBQU0sS0FBSyxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUMzRixJQUFNLEtBQUssR0FBSSxlQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFakMsS0FBSyxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFOUIsT0FBTyxHQUFHLGlCQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUMzQixHQUFHLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHO1lBQ3ZCLEdBQUcsRUFBRSxHQUFHO1lBQ1IsS0FBSyxFQUFFLEtBQUs7U0FDZixDQUFDLENBQUM7UUFFSCxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxVQUFVLElBQUk7WUFDOUIsZUFBUSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLFVBQVUsR0FBRztZQUN4QixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDZCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxJQUFJLEVBQUUsU0FBUyxpQkFBaUI7WUFDakMsZUFBUSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQztBQUNOLENBQUM7QUF2Q0QsNEJBdUNDO0FBQUEsQ0FBQyJ9