"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var task_utils_1 = require("./task.utils");
var watch_preprocess_1 = require("./watch.preprocess");
var watch_errors_1 = require("./watch.errors");
var blacklist = ["options", "bs-config", "before", "id"];
var _ = require("../lodash.custom");
exports.defaultWatchOptions = {
    ignoreInitial: true,
    block: false,
    throttle: 0,
    delay: 0,
    debounce: 0,
    group: 0,
};
/**
 * Create a single watch task item consisting of
 *  - patterns
 *  - tasks
 *  - options
 */
function createOne(name, index, item, itemOptions, globalOptions) {
    if (task_utils_1.isPlainObject(item)) {
        if (item.patterns && item.tasks) {
            return {
                patterns: [].concat(item.patterns).reduce(function (a, x) { return a.concat(x.split(":")); }, []),
                tasks: [].concat(item.tasks),
                options: _.merge({}, exports.defaultWatchOptions, globalOptions, itemOptions),
                watcherUID: name + "-" + index
            };
        }
        // todo: error handling for incorrect watcher formats ie: missing probs etc
    }
    return item;
}
/**
 * @param watchTaskParent
 * @param globalOptions
 * @returns {*}
 */
function getFormattedTask(name, watchTaskParent, globalOptions) {
    /**
     * Simple mode is when patterns + tasks given as top-level
     * keys. This means we automatically just into simple mode
     *  eg:
     *      default: {
     *          patterns: ['*.json']
     *          tasks: ['*.json']
     * }
     *
     */
    if (watchTaskParent.patterns && watchTaskParent.tasks) {
        return [createOne(name, 0, watchTaskParent, watchTaskParent.options, globalOptions)];
    }
    /**
     * Look at each key provided to decide if it can
     * be transformed into a watcher obj
     */
    return Object.keys(watchTaskParent)
        /**
         * Exclude black listed keys that cannot be watcher
         * names such as `options` or `before`
         */
        .filter(function (x) { return blacklist.indexOf(x) === -1; })
        .reduce(function (all, item, index) {
        /**
         * Here we assume the long-hand version is being
         * used where the watchers property is provided.
         * If it is, that means we can create a watcher
         * object for each item in the 'watchers' array
         * eg:
         *
         * default:
         *   options:
         *     exclude: '*.html'
         *   before: ['bs']
         *   watchers:
         *     - patterns: ['test/fixtures']
         *       tasks:    ['1', '2']
         *     - patterns: ['*.css']
         *       tasks:    '3'
         */
        if (item === "watchers") {
            /**
             * If the `watcher` property is an Array, it must
             * be an Array of Objects, so process each one individually.
             * eg:
             *  default:
             *      watchers: [
             *          {
             *              patterns: ["scss/**", "css/*.scss"],
             *              tasks:    ["$npm node-sass"],
             *          }
             *      ]
             */
            if (Array.isArray(watchTaskParent.watchers)) {
                return all.concat(watchTaskParent.watchers.map(function (watcher, i) {
                    return createOne(name, i, watcher, watchTaskParent.options, globalOptions);
                }));
            }
            /**
             * If the `watchers` property is a plain object,
             * use it's keys as watch patterns and the values as
             * tasks.
             * eg:
             *  default:
             *      watchers: {
             *          "*.js":   ["$npm eslint"],
             *          "*.scss": ["$npm node-sass"]
             *      }
             */
            if (task_utils_1.isPlainObject(watchTaskParent.watchers)) {
                return Object.keys(watchTaskParent.watchers)
                    .map(function (key, i) { return createOne(name, i, {
                    patterns: key,
                    tasks: watchTaskParent.watchers[key]
                }, watchTaskParent.options, globalOptions); });
            }
        }
        /**
         * At this point assume that the short-hard pattern <pattern>:<tasks>
         *  eg:
         *      "*.js": ['uglify']
         */
        return all.concat(createOne(name, index, {
            patterns: item,
            tasks: watchTaskParent[item] // value as the tasks array
        }, watchTaskParent.options, globalOptions));
    }, []);
}
function createFlattenedWatchTask(taskName, trigger) {
    var fromCli = ["block", "throttle", "debounce"].reduce(function (acc, key) {
        // console.log(typeof trigger.config[key]);
        if (typeof trigger.config[key] !== "undefined") {
            acc[key] = trigger.config[key];
        }
        return acc;
    }, {});
    var globalOptions = _.assign({}, trigger.input.watch.options, fromCli);
    var incoming = watch_preprocess_1.preprocessWatchTask(taskName);
    var selection = trigger.input.watch[incoming.taskName] || {};
    var watchers = getFormattedTask(incoming.taskName, selection, globalOptions);
    var errors = watch_errors_1.gatherWatchTaskErrors(incoming, trigger.input);
    return {
        name: taskName,
        before: selection.before || [],
        options: selection.options || {},
        watchers: watchers,
        errors: errors
    };
}
function validateTask(task, trigger) {
    return task.errors.length === 0;
}
function resolveWatchTasks(taskNames, trigger) {
    var taskList = taskNames
        .map(function (taskName) {
        return createFlattenedWatchTask(taskName, trigger);
    });
    /**
     * Return both valid & invalid tasks. We want to let consumers
     * handle errors/successes
     * @type {{valid: Array, invalid: Array}}
     */
    var output = {
        valid: taskList.filter(function (x) { return validateTask(x, trigger); }),
        invalid: taskList.filter(function (x) { return !validateTask(x, trigger); }),
        all: taskList
    };
    return output;
}
exports.resolveWatchTasks = resolveWatchTasks;
/**
 * The goal of this function is to produce a flat array containing tasks as strings
 * this allows us to feed that into the task resolution stuff
 */
function resolveBeforeTasks(beforeFlagsFromCliOrConfig, input, watchTasks) {
    var fromTopLevelInput = [].concat(input.watch.before);
    var fromWatchTasks = watchTasks.reduce(function (acc, item) {
        return acc.concat(item.before);
    }, []);
    return beforeFlagsFromCliOrConfig.concat(fromTopLevelInput, fromWatchTasks).filter(Boolean);
}
exports.resolveBeforeTasks = resolveBeforeTasks;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2F0Y2gucmVzb2x2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy93YXRjaC5yZXNvbHZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsMkNBQTJDO0FBRTNDLHVEQUF1RDtBQUN2RCwrQ0FBcUU7QUFRckUsSUFBTSxTQUFTLEdBQUcsQ0FBQyxTQUFTLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztBQUMzRCxJQUFNLENBQUMsR0FBVyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUVqQyxRQUFBLG1CQUFtQixHQUFtQjtJQUMvQyxhQUFhLEVBQUUsSUFBSTtJQUNuQixLQUFLLEVBQUUsS0FBSztJQUNaLFFBQVEsRUFBRSxDQUFDO0lBQ1gsS0FBSyxFQUFFLENBQUM7SUFDUixRQUFRLEVBQUUsQ0FBQztJQUNYLEtBQUssRUFBRSxDQUFDO0NBQ1gsQ0FBQztBQXFDRjs7Ozs7R0FLRztBQUNILFNBQVMsU0FBUyxDQUFDLElBQVksRUFBRSxLQUFhLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxhQUFhO0lBQzVFLElBQUksMEJBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUNyQixJQUFJLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUM3QixPQUFPO2dCQUNILFFBQVEsRUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQyxDQUFDLEVBQUUsQ0FBQyxJQUFLLE9BQUEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQXRCLENBQXNCLEVBQUUsRUFBRSxDQUFDO2dCQUNqRixLQUFLLEVBQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO2dCQUNqQyxPQUFPLEVBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsMkJB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