#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var config_1 = require("./config");
var task_runner_1 = require("./task.runner");
var cli_1 = require("./cli");
var fs_1 = require("fs");
var index_1 = require("./index");
var logger_1 = require("./logger");
var reports = require("./reporter.resolve");
var file = require("./file.utils");
var seq = require("./task.sequence");
var Rx = require("rx");
var file_utils_1 = require("./file.utils");
var debug = require("debug")("cb:cli");
var _ = require('../lodash.custom');
var parsed = cli_1.default(process.argv.slice(2));
var defaultReporter = reports.getDefaultReporter();
var defaultReporterFn = function (input) {
    var output = defaultReporter(input);
    if (output.data.length) {
        output.data.forEach(function (line) { return logger_1.default.info(line); });
    }
};
if (parsed.execute) {
    runFromCli(parsed, defaultReporterFn);
}
else {
    if (parsed.cli.flags.version) {
        console.log(parsed.output[0]);
    }
    else {
        if (parsed.output.length) {
            parsed.output.forEach(function (line) {
                logger_1.default.info(line);
            });
        }
    }
}
function runFromCli(parsed, cliDefaultReporter) {
    var addReporterIfMissing = function (setup, fn) {
        return setup.reporters.length > 0
            ? setup
            : _.assign({}, setup, { reportFn: fn });
    };
    var addSignalFnIfMissing = function (setup, obs) {
        return setup.config.signalObserver
            ? setup
            : _.set(setup, 'config.signalObserver', obs);
    };
    var addLoadDefaultsIfUndefined = function (cli) {
        return typeof cli.flags.loadDefaultInputs === "undefined"
            ? _.set(cli, 'flags.loadDefaultInputs', true)
            : cli;
    };
    var cliSignalObserver = new Rx.Subject();
    var killSwitches$ = new Rx.Subject();
    killSwitches$.subscribe(function () {
        process.exit(1);
    });
    file_utils_1.Right(parsed.cli)
        .map(function (cli) { return addLoadDefaultsIfUndefined(cli); })
        .chain(function (cli) { return index_1.getSetup(cli); })
        .map(function (x) { return addReporterIfMissing(x, cliDefaultReporter); })
        .map(function (x) { return addSignalFnIfMissing(x, cliSignalObserver); })
        .fold(function (err) {
        // todo log input errors
        cliDefaultReporter(err);
        killSwitches$.onNext(true);
        return err;
    }, function (setup) {
        setup.reportFn({
            type: reports.ReportTypes.UsingInputFile, data: { sources: setup.userInput.sources }
        });
        if (parsed.cli.command === 'run') {
            runWithSetup(setup, killSwitches$);
        }
        if (parsed.cli.command === 'docs') {
            docsWithSetup(setup, killSwitches$);
        }
        if (parsed.cli.command === 'init') {
            initWithSetup(setup, killSwitches$);
        }
        if (parsed.cli.command === 'tasks' || parsed.cli.command === 'ls') {
            tasksWithSetup(setup, killSwitches$);
        }
        if (parsed.cli.command === 'watch') {
            watchWithSetup(setup, killSwitches$);
        }
        if (parsed.cli.command === 'watchers') {
            watchersWithSetup(setup, killSwitches$);
        }
    });
}
function runWithSetup(prepared, killSwitches$) {
    var setUp$ = new Rx.BehaviorSubject({});
    var progress$ = new Rx.BehaviorSubject([]);
    var summaryGiven = false; // todo remove the need for this as it breaks the encapsulation
    var exitSignal$ = prepared.config.signalObserver
        .filter(function (x) { return x.type === config_1.SignalTypes.Exit; })
        .do(function (cbSignal) { return prepared.reportFn({
        type: reports.ReportTypes.SignalReceived,
        data: cbSignal.data
    }); })
        .withLatestFrom(setUp$, progress$, function (signal, setup, reports) {
        return { reports: reports, setup: setup, signal: signal };
    });
    var exits$ = Rx.Observable.zip(Rx.Observable.just(true).timestamp(prepared.config.scheduler), exitSignal$.timestamp(prepared.config.scheduler), function (begin, signal) {
        return { begin: begin, signal: signal };
    }).do(function (incoming) {
        var signal = incoming.signal, begin = incoming.begin;
        var setup = signal.value.setup;
        var reports = signal.value.reports;
        var startTime = begin.timestamp;
        var endTime = signal.timestamp;
        /**
         * Main summary report, although here it could be partial
         * (as an exit command could occur at any time)
         */
        if ((setup.tasks.valid.length * 2) !== reports.length) {
            if (!summaryGiven) {
                summaryGiven = true;
                handleCompletion(reports, setup, endTime - startTime);
            }
        }
        else {
            console.log("Exit signal, but summary given from main handler");
        }
    });
    var reports$ = index_1.handleIncoming(prepared)
        .do(function (x) { return setUp$.onNext(x.setup); }) // first item is the setup
        .flatMap(function (x) {
        if (x.setup.errors.length) {
            killSwitches$.onNext(true);
            return Rx.Observable.empty();
        }
        if (x.setup.tasks.invalid.length) {
            killSwitches$.onNext(true);
            return Rx.Observable.empty();
        }
        return x.update$;
    })
        .do(function (x) { return progress$.onNext(progress$.getValue().concat(x)); })
        .do(function (report) {
        prepared.reportFn({
            type: reports.ReportTypes.TaskReport,
            data: {
                report: report,
                config: prepared.config
            }
        });
    })
        .takeUntil(exits$)
        .toArray()
        .filter(function (reports) { return reports.length > 0; })
        .timestamp(prepared.config.scheduler)
        .withLatestFrom(setUp$, function (incoming, setup) {
        return {
            setup: setup,
            reports: incoming.value,
            timestamp: incoming.timestamp
        };
    });
    Rx.Observable.zip(Rx.Observable.just(true).timestamp(prepared.config.scheduler), reports$, function (begin, result) {
        return { begin: begin, result: result };
    }).subscribe(function (incoming) {
        if (!summaryGiven) {
            summaryGiven = true;
            handleCompletion(incoming.result.reports, incoming.result.setup, incoming.result.timestamp - incoming.begin.timestamp);
        }
    });
    /**
     * Handle file-writes
     * @type {Rx.Observable<CBSignal<FileWriteSignal>>|Rx.Observable<T>}
     */
    prepared.config.signalObserver
        .filter(function (x) { return x.type === config_1.SignalTypes.FileWrite; })
        .do(function (x) {
        if (prepared.config.dryRun) {
            // should skip / noop here
        }
        else {
            file.writeFileToDisk(x.data.file, x.data.content);
        }
    }).subscribe();
    /**
     * Because errors are handled by reports, task executions ALWAYS complete
     * and we handle that here.
     */
    function handleCompletion(taskReports, setup, runtime) {
        /**
         * Merge sequence tree with Task Reports
         */
        var decoratedSequence = seq.decorateSequenceWithReports(setup.sequence, taskReports);
        /**
         * Push a 'Completion report' onto the $complete Observable.
         * This means consumers will get everything when they call
         */
        var errors = taskReports.filter(function (x) { return x.type === task_runner_1.TaskReportType.error; });
        var completeData = {
            errors: errors,
            runtime: runtime,
            taskErrors: errors,
            sequence: decoratedSequence,
            cli: prepared.cli,
            config: prepared.config
        };
        /**
         * Main summary report
         */
        prepared.reportFn({
            type: reports.ReportTypes.Summary,
            data: completeData
        });
        require("./command.run.post-execution").postCliExecution(completeData);
    }
}
function docsWithSetup(prepared, killSwitches$) {
    index_1.handleIncoming(prepared)
        .pluck("setup")
        .subscribe(function (setup) {
        if (setup.errors.length) {
            return killSwitches$.onNext(true);
        }
        if (setup.output) {
            setup.output.forEach(function (outputItem) {
                file.writeFileToDisk(outputItem.file, outputItem.content);
            });
        }
    });
}
function initWithSetup(prepared, killSwitches$) {
    index_1.handleIncoming(prepared)
        .pluck("setup")
        .subscribe(function (setup) {
        if (setup.errors.length) {
            return killSwitches$.onNext(true);
        }
        fs_1.writeFileSync(setup.outputFilePath, fs_1.readFileSync(setup.templateFilePath));
    });
}
function tasksWithSetup(prepared, killSwitches$) {
    index_1.handleIncoming(prepared)
        .subscribe(function (x) {
        var _a = x.setup, groups = _a.groups, tasks = _a.tasks;
        var invalid = groups.reduce(function (acc, group) { return acc.concat(group.tasks.invalid); }, []);
        if (invalid.length || prepared.config.verbose === 1 /* Verbose */) {
            return prepared.reportFn({
                type: reports.ReportTypes.TaskTree,
                data: {
                    tasks: tasks,
                    config: prepared.config,
                    title: invalid.length ? "Errors found:" : "Available Tasks:"
                }
            });
        }
        if (!groups.length) {
            return prepared.reportFn({ type: reports.ReportTypes.NoTasksAvailable });
        }
        prepared.reportFn({
            type: reports.ReportTypes.SimpleTaskList,
            data: { setup: x.setup }
        });
    });
}
function watchWithSetup(prepared, killSwitches$) {
    index_1.handleIncoming(prepared)
        .flatMap(function (x) {
        if (x.setup.errors.length) {
            killSwitches$.onNext(true);
            return Rx.Observable.empty();
        }
        return x.update$; // start the watchers
    })
        .subscribe();
}
function watchersWithSetup(prepared, killSwitches$) {
    index_1.handleIncoming(prepared)
        .pluck("setup")
        .subscribe(function (setup) {
        if (setup.errors.length) {
            return killSwitches$.onNext(true);
        }
        prepared.reportFn({
            type: reports.ReportTypes.WatcherNames,
            data: { setup: setup }
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY2IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBS0EsbUNBQTRFO0FBRzVFLDZDQUF5RDtBQUt6RCw2QkFBd0I7QUFDeEIseUJBQStDO0FBQy9DLGlDQUFnRTtBQUNoRSxtQ0FBOEI7QUFHOUIsNENBQThDO0FBQzlDLG1DQUFxQztBQUNyQyxxQ0FBdUM7QUFFdkMsdUJBQTBCO0FBQzFCLDJDQUFtQztBQUVuQyxJQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDekMsSUFBTSxDQUFDLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDdEMsSUFBTSxNQUFNLEdBQUcsYUFBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFFMUMsSUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixFQUFFLENBQUM7QUFDckQsSUFBTSxpQkFBaUIsR0FBRyxVQUFDLEtBQUs7SUFDNUIsSUFBTSxNQUFNLEdBQUcsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3RDLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7UUFDcEIsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxnQkFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBakIsQ0FBaUIsQ0FBQyxDQUFDO0tBQ2xEO0FBQ0wsQ0FBQyxDQUFDO0FBRUYsSUFBSSxNQUFNLENBQUMsT0FBTyxFQUFFO0lBQ2hCLFVBQVUsQ0FBQyxNQUFNLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztDQUN6QztLQUFNO0lBQ0gsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUU7UUFDMUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFB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