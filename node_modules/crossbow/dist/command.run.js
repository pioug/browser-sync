"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Rx = require("rx");
var reporter_resolve_1 = require("./reporter.resolve");
var task_resolve_1 = require("./task.resolve");
var Immutable = require("immutable");
var seq = require("./task.sequence");
var command_run_interactive_1 = require("./command.run.interactive");
var command_run_execute_1 = require("./command.run.execute");
var command_run_execute_2 = require("./command.run.execute");
var task_utils_1 = require("./task.utils");
var debug = require("debug")("cb:command.run");
var _ = require("../lodash.custom");
var TriggerTypes;
(function (TriggerTypes) {
    TriggerTypes[TriggerTypes["command"] = "command"] = "command";
    TriggerTypes[TriggerTypes["watcher"] = "watcher"] = "watcher";
})(TriggerTypes = exports.TriggerTypes || (exports.TriggerTypes = {}));
function getRunCommandSetup(trigger) {
    var cliInput = trigger.cli.input.slice(1);
    /**
     * Task Tracker for external observers
     * @type {Subject<T>}
     */
    trigger.tracker = new Rx.Subject();
    trigger.tracker$ = trigger.tracker.share();
    /**
     * First Resolve the task names given in input.
     */
    var tasks = task_resolve_1.resolveTasks(cliInput, trigger);
    var topLevelParallel = tasks.all.some(function (task) {
        return task.runMode === task_resolve_1.TaskRunModes.parallel;
    });
    /**
     * If only 1 task is being run, check if any sub-tasks
     * are trying to be run in parallel mode and if so, set the runMode
     * This is done to ensure if a child errors, it doesn't affect children.
     * (as it's only a single task via the cli, it wouldn't be expected)
     */
    if (cliInput.length === 1 && topLevelParallel) {
        trigger.config.runMode = task_resolve_1.TaskRunModes.parallel;
    }
    /**
     * All this point, all given task names have been resolved
     * to either modules on disk, or @adaptor tasks, so we can
     * go ahead and create a flattened run-sequence
     */
    var sequence = seq.createFlattenedSequence(tasks.valid, trigger);
    /**
     * With the flattened sequence, we can create nested collections
     * of Rx Observables
     */
    var runner = seq.createRunner(sequence, trigger);
    /**
     * Check if the user intends to handle running the tasks themselves,
     * if thats the case we give them the resolved tasks along with
     * the sequence and the primed runner
     */
    return { tasks: tasks, sequence: sequence, runner: runner };
}
exports.getRunCommandSetup = getRunCommandSetup;
function handleIncomingRunCommand(cli, input, config, reporter) {
    /**
     * Array of top-level task names that are available
     */
    var topLevelTasks = Object.keys(input.tasks);
    /**
     * The shared Map that tasks can read/write to
     */
    var sharedMap = new Rx.BehaviorSubject(Immutable.Map({}));
    var type = TriggerTypes.command;
    debug("top level tasks available", topLevelTasks);
    /**
     * If the interactive flag was given (-i), always try
     * that first.
     */
    if (config.interactive) {
        return enterInteractive();
    }
    /**
     * If the user never provided a task then we either look
     * for a `default` task or enter interactive mode if possible
     * eg:
     *  $ crossbow run
     */
    if (cli.input.length === 1) {
        /**
         * First look if there's a 'default' task defined
         */
        if (hasDefaultTask()) {
            var cliMerged = _.merge({}, cli, { input: ["run", "default"] });
            return Rx.Observable.just(command_run_execute_1.default({
                shared: sharedMap,
                cli: cliMerged,
                input: input,
                config: config,
                reporter: reporter,
                type: TriggerTypes.command
            }));
        }
        /**
         * If no default task was found above, enter interactive mode
         */
        return enterInteractive();
    }
    /**
     * Finally check if tasks were provided on the CLI, but were parents
     */
    var maybes = cli.input.slice(1);
    var maybeParents = maybes.filter(function (x) { return task_utils_1.isParentRef(x, topLevelTasks.filter(task_utils_1.isParentGroupName)); });
    /**
     * If any parent task names were given, go into interactive mode
     */
    if (maybeParents.length) {
        return enterInteractive();
    }
    /**
     * Check if the provided input contains either
     * 'default' or 'default@p' etc
     */
    function hasDefaultTask() {
        if (task_resolve_1.maybeTaskNames(input.tasks, "default").length) {
            return true;
        }
        if (input.tasks["default"] !== undefined) {
            return true;
        }
    }
    /**
     * If no task given, or if user has selected interactive mode,
     * show the UI for task selection
     */
    function enterInteractive() {
        /**
         * No top level tasks, so exit with the correct error
         */
        if (!topLevelTasks.length) {
            reporter({ type: reporter_resolve_1.ReportTypes.NoTasksAvailable });
            return Rx.Observable.just({
                setup: {
                    sequence: [],
                    tasks: { all: [], valid: [], invalid: [] },
                    errors: [{ type: command_run_execute_2.RunCommandReportTypes.NoTasks }]
                },
                update$: Rx.Observable.empty()
            });
        }
        /**
         * Log that no tasks were provided
         */
        reporter({ type: reporter_resolve_1.ReportTypes.NoTasksProvided });
        /**
         * Now prompt for input
         */
        return command_run_interactive_1.default(cli, input, config, reporter)
            .flatMap(function (answers) {
            var cliMerged = _.assign({}, cli, { input: ["run"].concat(answers.tasks) });
            var configMerged = _.merge({}, config, { runMode: task_resolve_1.TaskRunModes.parallel });
            return Rx.Observable.just(command_run_execute_1.default({
                shared: sharedMap,
                cli: cliMerged,
                input: input,
                reporter: reporter,
                config: configMerged,
                type: type
            }));
        });
    }
    /**
     * If we reach here we're dealing with the default case
     * where we are simply executing the command as normal
     * eg:
     *  $ crossbow run task1 task2@p etc ...
     */
    return Rx.Observable.just(command_run_execute_1.default({
        shared: sharedMap,
        cli: cli,
        input: input,
        config: config,
        reporter: reporter,
        type: type
    }));
}
exports.default = handleIncomingRunCommand;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZC5ydW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY29tbWFuZC5ydW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx1QkFBMEI7QUFHMUIsdURBQStDO0FBQy9DLCtDQUEwRTtBQUsxRSxxQ0FBd0M7QUFDeEMscUNBQXVDO0FBQ3ZDLHFFQUE0RDtBQUM1RCw2REFBc0Q7QUFDdEQsNkRBQTREO0FBRTVELDJDQUE0RDtBQUk1RCxJQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUNqRCxJQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQXFCdEMsSUFBWSxZQUdYO0FBSEQsV0FBWSxZQUFZO0lBQ3BCLHVDQUFlLFNBQVMsYUFBQSxDQUFBO0lBQ3hCLHVDQUFlLFNBQVMsYUFBQSxDQUFBO0FBQzVCLENBQUMsRUFIVyxZQUFZLEdBQVosb0JBQVksS0FBWixvQkFBWSxRQUd2QjtBQUVELFNBQWdCLGtCQUFrQixDQUFDLE9BQXVCO0lBQ3RELElBQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUU1Qzs7O09BR0c7SUFDSCxPQUFPLENBQUMsT0FBTyxHQUFHLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ25DLE9BQU8sQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUUzQzs7T0FFRztJQUNILElBQU0sS0FBSyxHQUFHLDJCQUFZLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzlDLElBQU0sZ0JBQWdCLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJO1FBQ2xELE9BQU8sSUFBSSxDQUFDLE9BQU8sS0FBSywyQkFBWSxDQUFDLFFBQVEsQ0FBQztJQUNsRCxD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