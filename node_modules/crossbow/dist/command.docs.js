"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var command_run_1 = require("./command.run");
var task_resolve_1 = require("./task.resolve");
var Rx = require("rx");
var reporter_resolve_1 = require("./reporter.resolve");
var task_utils_1 = require("./task.utils");
var fs_1 = require("fs");
var file = require("./file.utils");
var defaultReporter_1 = require("./reporters/defaultReporter");
var logger_1 = require("./logger");
var debug = require("debug")("cb:command:docs");
var DocsErrorTypes;
(function (DocsErrorTypes) {
    DocsErrorTypes[DocsErrorTypes["DocsInputFileNotFound"] = "DocsInputFileNotFound"] = "DocsInputFileNotFound";
    DocsErrorTypes[DocsErrorTypes["DocsOutputFileExists"] = "DocsOutputFileExists"] = "DocsOutputFileExists";
})(DocsErrorTypes = exports.DocsErrorTypes || (exports.DocsErrorTypes = {}));
exports.docStartComment = "<!--crossbow-docs-start-->";
exports.docEndComment = "<!--crossbow-docs-end-->";
exports.hasRegExp = /<!--crossbow-docs-start-->([\s\S]+?)?<!--crossbow-docs-end-->/g;
exports.hasExistingComments = function (inputString) { return exports.hasRegExp.test(inputString); };
exports.readmeRegExp = /readme\.(md|markdown)$/i;
function execute(trigger) {
    var input = trigger.input, config = trigger.config, reporter = trigger.reporter;
    /**
     * Resolve all top-level tasks as these are the ones
     * that will used in the docs
     * @type {Tasks}
     */
    var toResolve = task_utils_1.getPossibleTaskNames(input);
    var tasks = task_resolve_1.resolveTasks(toResolve
        .filter(task_utils_1.isPublicTask)
        .filter(function (x) { return !task_utils_1.isInternal(x); }), trigger);
    /**
     * If there were 0 tasks, exit with error
     */
    if (tasks.all.length === 0) {
        reporter({ type: reporter_resolve_1.ReportTypes.NoTasksAvailable });
        return Rx.Observable.just({
            setup: {
                tasks: tasks,
                errors: [{ type: reporter_resolve_1.ReportTypes.NoTasksAvailable }]
            }
        });
    }
    debug("Amount of tasks to consider " + tasks.all.length);
    /**
     * If any tasks were invalid, refuse to generate docs
     * and prompt to run tasks command (for the full error output)
     */
    if (tasks.invalid.length) {
        debug("Tasks were invalid, so skipping doc generation completely");
        reporter({ type: reporter_resolve_1.ReportTypes.DocsInvalidTasksSimple });
        return Rx.Observable.just({
            setup: {
                tasks: tasks,
                errors: [{ type: reporter_resolve_1.ReportTypes.DocsInvalidTasksSimple }]
            }
        });
    }
    var markdown = getMarkdown(tasks.valid);
    /**
     * If the user provided the --file flag,
     * try to load that file & either wedge in the new docs or
     * append them
     */
    if (config.file) {
        return Rx.Observable.just({ setup: handleFileFlag(tasks, markdown, trigger) });
    }
    /**
     * If a user provides the 'output' flag, it means they want a new file creating
     */
    if (config.output) {
        return Rx.Observable.just({ setup: handleOutputFlag(tasks, markdown, trigger) });
    }
    /**
     * If both --flag and --output were NOT given, look for a readme in this current
     * directory
     * @type {Array}
     */
    var existingReadmeFiles = fs_1.readdirSync(process.cwd())
        .filter(function (x) { return exports.readmeRegExp.test(x); })
        .reduce(function (acc, item) { return acc.concat(file.readFilesFromDiskWithContent([item], config.cwd)); }, []);
    if (existingReadmeFiles.length) {
        var output_1 = existingReadmeFiles.map(function (x) { return getFileOutput(x, markdown); });
        reportAddToDocs(output_1, trigger);
        return Rx.Observable.just({
            setup: {
                errors: [],
                tasks: tasks,
                markdown: markdown,
                output: output_1
            }
        });
    }
    /**
     * At this point:
     * 1. NO --file flag given
     * 2. NO --output flag given
     * 3. NO existing readme files in cwd
     *
     * so, create a new one :)
     */
    var output = [{
            file: file.getStubFile("readme.md", config.cwd),
            content: markdown
        }];
    reportAddToDocs(output, trigger);
    return Rx.Observable.just({
        setup: {
            errors: [],
            tasks: tasks,
            markdown: markdown,
            output: output
        }
    });
}
/**
 * When adding docs to a file
 * 1. if file content does not exist, use raw markdown
 * 2. if docs exist, replace them
 * 3. if 1 & 2 fail, append
 */
function getFileOutput(file, markdown) {
    /**
     * If there's no exisitng file content, just use the markdown
     */
    if (!file.content) {
        debug(file.relative + " DOES NOT have any content");
        return { file: file, content: markdown };
    }
    /**
     * If there's existing docs, wedge.
     */
    if (exports.hasExistingComments(file.content)) {
        debug(file.relative + " has the comments already in the file, so will replace");
        var replaced = file.content.replace(exports.hasRegExp, markdown);
        return {
            file: file,
            content: replaced
        };
    }
    debug(file.relative + " DOES NOT have the comments, so will append to the end of the file");
    return {
        file: file,
        content: file.content + "\n" + markdown
    };
}
/**
 * When the --output flag was given
 *
 * eg:
 *
 *      $ crossbow docs --output newfile.md
 */
function handleOutputFlag(tasks, markdown, trigger) {
    var config = trigger.config, reporter = trigger.reporter;
    var maybe = file.readFilesFromDiskWithContent([config.output], config.cwd);
    var available = maybe
        .filter(function (x) { return x.errors.length > 0; })
        .filter(function (x) { return x.errors[0].type === task_utils_1.InputErrorTypes.FileNotFound; });
    if (!available.length) {
        var error = { type: DocsErrorTypes.DocsOutputFileExists, file: maybe[0] };
        if (!config.handoff) {
            reporter({ type: reporter_resolve_1.ReportTypes.DocsOutputFileExists, data: { error: error } });
        }
        return {
            errors: [error],
            tasks: tasks,
            markdown: markdown,
            output: []
        };
    }
    var output = [{
            file: maybe[0],
            content: markdown
        }];
    // Now we can report about writing to disk
    reportAddToDocs(output, trigger);
    return {
        errors: [],
        tasks: tasks,
        markdown: markdown,
        output: output
    };
}
/**
 * When the --file flag was given.
 *
 * eg:
 *
 *      $ crossbow docs --file readme.md
 */
function handleFileFlag(tasks, markdown, trigger) {
    var config = trigger.config, reporter = trigger.reporter;
    /**
     * Try to read the file from disk with content appended
     * @type {file.ExternalFileContent[]}
     */
    var maybes = file.readFilesFromDiskWithContent([config.file], config.cwd);
    var withErrors = maybes
        .filter(function (x) { return x.errors.length > 0; })
        .map(function (x) {
        return {
            type: DocsErrorTypes.DocsInputFileNotFound,
            file: x
        };
    });
    /**
     * If the --file flag produced an error,
     * eg: --file shane.md -> but shane.md did not exist
     */
    if (withErrors.length) {
        /**
         * If we're not handing off, report the error
         */
        if (!config.handoff) {
            reporter({ type: reporter_resolve_1.ReportTypes.DocsInputFileNotFound, data: { error: withErrors[0] } });
        }
        return {
            errors: withErrors,
            tasks: tasks,
            markdown: markdown,
            output: []
        };
    }
    /**
     * At this point we have files to work with so we
     * either append the docs or insert them between existing
     * comments
     * @type {{content: string, file: file.ExternalFileContent}[]}
     */
    var output = maybes.map(function (x) { return getFileOutput(x, markdown); });
    /**
     * Now write to file
     */
    reportAddToDocs(output, trigger);
    /**
     * Always return everything gathered
     */
    return {
        errors: [],
        tasks: tasks,
        markdown: markdown,
        output: output
    };
}
function getMarkdown(tasks) {
    /**
     * Create the header for the markdown table
     * @type {string|string[]}
     */
    var tasksHeader = ["## Crossbow tasks\n\nThe following tasks have been defined by this project's Crossbow configuration.\nRun any of them in the following way\n \n```shell\n$ crossbow run <taskname>\n```"];
    var tableHeader = "|Task name|Description|\n|---|---|";
    /**
     * Create the body for the table with taskname + description
     * @type {string[]}
     */
    var body = tasks.map(function (task) {
        var isParent = task.type === task_resolve_1.TaskTypes.ParentGroup;
        var name = (function () {
            if (isParent) {
                return "|<pre>`" + task.baseTaskName + ":" + task.subTasks[0] + "`</pre>";
            }
            return "|<pre>`" + task.baseTaskName + "`</pre>";
        })();
        var desc = (function () {
            if (task.description)
                return task_utils_1.removeNewlines(task.description);
            if (isParent) {
                if (task.tasks[0].description) {
                    return task_utils_1.removeNewlines(task.tasks[0].description);
                }
            }
            if (task.tasks.length) {
                var subject = task.tasks;
                return ["**Alias for:**"]
                    .concat(subject
                    .map(function (x) { return "- `" + defaultReporter_1.getLabel(x) + "`"; })
                    .map(function (x) { return logger_1.clean(x); }))
                    .join("<br>");
            }
        })() + "|";
        return [name, desc].join("|");
    }).join("\n");
    /**
     * Join the lines with a \n for correct formatting in markdown
     * @type {string}
     */
    return [exports.docStartComment, tasksHeader, tableHeader, body, exports.docEndComment].join("\n");
}
function reportAddToDocs(output, trigger) {
    var config = trigger.config;
    if (!config.handoff) {
        output.forEach(function (x) {
            trigger.reporter({
                type: reporter_resolve_1.ReportTypes.DocsAddedToFile,
                data: {
                    file: x.file
                }
            });
        });
    }
}
function handleIncomingDocsCommand(cli, input, config, reporter) {
    return execute({
        cli: cli,
        input: input,
        config: config,
        reporter: reporter,
        type: command_run_1.TriggerTypes.command
    });
}
exports.default = handleIncomingDocsCommand;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZC5kb2NzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbW1hbmQuZG9jcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZDQUEyRDtBQUczRCwrQ0FBOEQ7QUFFOUQsdUJBQTBCO0FBQzFCLHVEQUErQztBQUUvQywyQ0FBNkc7QUFDN0cseUJBQStCO0FBQy9CLG1DQUFxQztBQUVyQywrREFBcUQ7QUFDckQsbUNBQStCO0FBRS9CLElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBU2xELElBQVksY0FHWDtBQUhELFdBQVksY0FBYztJQUN0Qix5REFBNkIsdUJBQXVCLDJCQUFBLENBQUE7SUFDcEQsd0RBQTRCLHNCQUFzQiwwQkFBQSxDQUFBO0FBQ3RELENBQUMsRUFIVyxjQUFjLEdBQWQsc0JBQWMsS0FBZCxzQkFBYyxRQUd6QjtBQUNZLFFBQUEsZUFBZSxHQUFHLDRCQUE0QixDQUFDO0FBQy9DLFFBQUEsYUFBYSxHQUFHLDBCQUEwQixDQUFDO0FBQzNDLFFBQUEsU0FBUyxHQUFHLGdFQUFnRSxDQUFDO0FBQzdFLFFBQUEsbUJBQW1CLEdBQUcsVUFBQyxXQUFXLElBQUssT0FBQSxpQkFBUyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBM0IsQ0FBMkIsQ0FBQztBQUNuRSxRQUFBLFlBQVksR0FBRyx5QkFBeUIsQ0FBQztBQWV0RCxTQUFTLE9BQU8sQ0FBQyxPQUF1QjtJQUU3QixJQUFBLHFCQUFLLEVBQUUsdUJBQU0sRUFBRSwyQkFBUSxDQUFZO0lBRTFDOzs7O09BSUc7SUFDSCxJQUFNLFNBQVMsR0FBRyxpQ0FBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM5QyxJQUFNLEtBQUssR0FBRywyQkFBWSxDQUFDLFNBQVM7U0FDL0IsTUFBTSxDQUFDLHlCQUFZLENBQUM7U0FDcEIsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyx1QkFB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