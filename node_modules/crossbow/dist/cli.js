"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var cli_commands_1 = require("./cli.commands");
var _ = require("../lodash.custom");
var cli_parse_1 = require("./cli.parse");
function default_1(args) {
    var command = args[0];
    var match = getCommand(command, cli_commands_1.commands);
    if (!match.length) {
        // first look if the user provided a --version flag
        var cli_1 = cli_parse_1.default(["no-command"].concat(args), require("../opts/global-common.json"));
        if (cli_1.flags.version) {
            return { cli: cli_1, execute: false, output: [require("../package.json").version] };
        }
        var commandOptions_1 = cli_commands_1.commands["run"].opts.map(require);
        var opts_1 = _.merge.apply(_, [{}].concat(commandOptions_1));
        var cli2 = cli_parse_1.default(["run"].concat(args), opts_1);
        /**
         * If there was additional input, try to run a task
         */
        if (cli2.input.length > 1) {
            return { cli: cli2, execute: true, output: [] };
        }
        return { cli: cli2, execute: false, output: [printHelp(cli_commands_1.commands)] };
    }
    var commandName = match[0];
    var commandOptions = cli_commands_1.commands[commandName].opts.map(require);
    var opts = _.merge.apply(_, [{}].concat(commandOptions));
    var cli = cli_parse_1.default(args, opts);
    /**
     * Here, the user gave the --help flag along with a valid
     * command. So we show command-specific help
     */
    if (cli.flags.help) {
        return { cli: cli, execute: false, output: [cli_commands_1.commands[match[0]].help] };
    }
    return { cli: cli, execute: true, output: [] };
}
exports.default = default_1;
function printHelp(commands) {
    return "Usage: crossbow [command] [..args] [OPTIONS]\n\n{bold:Crossbow Commands:} \n\n" + cli_commands_1.twoColFromJson(commands, "description") + "\n\n{bold:Example: Run the task 'build-js'}\n\n    $ crossbow run build-js\n    \n{bold:Example: Run the tasks build-css and build-js in sequence}\n\n    $ crossbow run build-css build-js\n        \n{bold:For more detailed help, use the command name + the --help flag}\n\n    $ crossbow run --help\n    $ crossbow init --help\n";
}
function getCommand(incoming, commands) {
    return Object.keys(commands).reduce(function (acc, item) {
        var selected = commands[item];
        /**
         * A direct match - this means the typed command matches
         * an command name exactly.
         *
         * eg:
         *  $ crossbow run
         *
         * -> ['run']
         */
        if (item === incoming) {
            return acc.concat(item);
        }
        /**
         * An alias match is when a short-hand command was given
         * and it existed in the 'alias' array for a command.
         *
         * eg:
         *
         *  $ crossbow run
         *
         * commands:
         *
         * run: { alias:['run', 'r'] }
         *
         * -> ['run']
         *
         */
        if (selected.alias && selected.alias.indexOf(incoming) > -1) {
            return acc.concat(item);
        }
        return acc;
    }, []);
}
exports.getCommand = getCommand;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NsaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtDQUFxRTtBQUNyRSxJQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUN0Qyx5Q0FBK0M7QUFRL0MsbUJBQXlCLElBQWM7SUFFbkMsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3hCLElBQU0sS0FBSyxHQUFLLFVBQVUsQ0FBQyxPQUFPLEVBQUUsdUJBQVEsQ0FBQyxDQUFDO0lBRTlDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO1FBRWYsbURBQW1EO1FBQ25ELElBQU0sS0FBRyxHQUFHLG1CQUFLLEVBQUUsWUFBWSxTQUFLLElBQUksR0FBRyxPQUFPLENBQUMsNEJBQTRCLENBQUMsQ0FBQyxDQUFDO1FBRWxGLElBQUksS0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUU7WUFDbkIsT0FBTyxFQUFDLEdBQUcsT0FBQSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUMsQ0FBQztTQUM5RTtRQUVELElBQU0sZ0JBQWMsR0FBRyx1QkFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDekQsSUFBTSxNQUFJLEdBQWEsQ0FBQyxDQUFDLEtBQUssT0FBUCxDQUFDLEdBQU8sRUFBRSxTQUFLLGdCQUFjLEVBQUMsQ0FBQztRQUN0RCxJQUFNLElBQUksR0FBYyxtQkFBSyxFQUFFLEtBQUssU0FBSyxJQUFJLEdBQUcsTUFBSSxDQUFDLENBQUM7UUFFdEQ7O1dBRUc7UUFDSCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN2QixPQUFPLEVBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUMsQ0FBQztTQUNqRDtRQUVELE9BQU8sRUFBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLENBQUMsU0FBUyxDQUFDLHVCQUFRLENBQUMsQ0FBQyxFQUFDLENBQUM7S0FDckU7SUFFRCxJQUFNLFdBQVcsR0FBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDaEMsSUFBTSxjQUFjLEdBQUcsdUJBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQy9ELElBQU0sSUFBSSxHQUFhLENBQUMsQ0FBQyxLQUFLLE9BQVAsQ0FBQyxHQUFPLEVBQUUsU0FBSyxjQUFjLEVBQUMsQ0FBQztJQUN0RCxJQUFNLEdBQUcsR0FBYyxtQkFBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUV6Qzs7O09BR0c7SUFDSCxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFO1FBQ2hCLE9BQU8sRUFBQyxHQUFHLEtBQUEsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxDQUFDLHVCQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsQ0FBQztLQUNuRTtJQUVELE9BQU8sRUFBQyxHQUFHLEtBQUEsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUMsQ0FBQztBQUM1QyxDQUFDO0FBMUNELDRCQTBDQztBQUVELFNBQVMsU0FBUyxDQUFFLFFBQVE7SUFDeEIsT0FBTyxtRkFJVCw2QkFBYyxDQUFDLFFBQVEsRUFBRSxhQUFhLENBQUMsNFVBY3hDLENBQUM7QUFDRixDQUFDO0FBRUQsU0FBZ0IsVUFBVSxDQUFDLFFBQWdCLEVBQUUsUUFBcUI7SUFFOUQsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLEdBQUcsRUFBRSxJQUFJO1FBRW5ELElBQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVoQzs7Ozs7Ozs7V0FRRztRQUNILElBQUksSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUNuQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDM0I7UUFFRDs7Ozs7Ozs7Ozs7Ozs7V0FjRztRQUNILElBQUksUUFBUSxDQUFDLEtBQUssSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtZQUN6RCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDM0I7UUFFRCxPQUFPLEdBQUcsQ0FBQztJQUNmLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUNYLENBQUM7QUF4Q0QsZ0NBd0NDIn0=